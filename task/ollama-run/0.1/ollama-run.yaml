apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: ollama-run
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.54.0"
    tekton.dev/categories: AI
    tekton.dev/tags: ai, llm, ollama
    tekton.dev/displayName: "Ollama Run"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    Run an Ollama Large Language Model (LLM) using reusable StepActions.
    First pulls the model, then generates a response.
    
  workspaces:
    - name: ollama-cache
      description: Persistent storage for Ollama models.

  params:
    - name: model
      description: The name of the model to use.
      type: string
    - name: prompt
      description: The prompt to send to the model.
      type: string
    - name: ollama-image
      description: The container image for Ollama (Sidecar).
      type: string
      default: docker.io/ollama/ollama:latest

  results:
    - name: response
      description: The response generated by the model.

  sidecars:
    - name: ollama-server
      image: $(params.ollama-image)
      env:
        - name: OLLAMA_HOST
          value: "0.0.0.0:11434"
      volumeMounts:
        - name: $(workspaces.ollama-cache.volume)
          mountPath: /root/.ollama
      readinessProbe:
        httpGet:
          path: /
          port: 11434
        initialDelaySeconds: 5
        periodSeconds: 5

  steps:
    - name: pull
      ref:
        name: ollama-pull
      params:
        - name: model
          value: $(params.model)
        - name: ollama-host
          value: "http://localhost:11434"
          
    - name: generate
      ref:
        name: ollama-generate
      params:
        - name: model
          value: $(params.model)
        - name: prompt
          value: $(params.prompt)
        - name: ollama-host
          value: "http://localhost:11434"
          
    - name: output-result
      image: alpine
      env:
        - name: GENERATED_RESPONSE
          value: $(steps.generate.results.response)
      script: |
        #!/bin/sh
        echo -n "$GENERATED_RESPONSE" > $(results.response.path)
        echo "Response:"
        echo "$GENERATED_RESPONSE"
